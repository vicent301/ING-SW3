trigger:
  - main

resources:
  repositories:
    - repository: self
      type: git
      name: APP_WEB
      ref: main
      checkoutOptions:
        clean: true
        submodules: false
      path: APP_WEB

variables:
  buildConfiguration: 'Release'

stages:
  # =========================
  # 0) TESTS FRONTEND + BACKEND (coverage sin umbral)
  # =========================
  - stage: Frontend_Backend_Tests
    displayName: "Test Front + Back"
    jobs:
      # ---------- FRONTEND ----------
      - job: RunFrontendTests
        displayName: "Pruebas Frontend"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            clean: true
            persistCredentials: true

          - task: NodeTool@0
            inputs:
              versionSpec: "20.x"

          - script: |
              cd frontend
              npm ci
              # Vitest con cobertura (Istanbul) + reporte JUnit
              npx vitest run --coverage --reporter=junit --outputFile test-results.xml
            displayName: "Run Vitest + coverage (Istanbul)"

          - task: PublishTestResults@2
            displayName: "Publicar tests Frontend (JUnit)"
            inputs:
              testResultsFormat: "JUnit"
              testResultsFiles: "frontend/test-results.xml"
              testRunTitle: "Vitest"
              failTaskOnFailedTests: true
            condition: succeededOrFailed()

          - task: PublishCodeCoverageResults@2
            displayName: "Publicar coverage Frontend"
            inputs:
              codeCoverageTool: "Cobertura"
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/frontend/coverage/cobertura-coverage.xml"
              reportDirectory: "$(System.DefaultWorkingDirectory)/frontend/coverage"
              failIfCoverageEmpty: false
            condition: succeededOrFailed()

          - task: PublishBuildArtifacts@1
            displayName: "Artefacto: coverage HTML Front"
            inputs:
              ArtifactName: "coverage-front"
              PathtoPublish: "frontend/coverage"

      # ---------- BACKEND ----------
      - job: RunBackendTests
        displayName: "Pruebas Backend"
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: self
            clean: true
            persistCredentials: true

          - task: GoTool@0
            inputs:
              version: '1.21.6'

          - script: |
              set -euo pipefail
              cd backend
              go mod download
              # Herramientas para JUnit y Cobertura
              go install github.com/jstemmer/go-junit-report@latest
              go install github.com/boumenot/gocover-cobertura@latest
              # Tests con cobertura
              go test ./... -v -covermode=atomic -coverprofile=coverage.out | $(go env GOPATH)/bin/go-junit-report > junit-backend.xml
              # coverprofile -> Cobertura
              cat coverage.out | $(go env GOPATH)/bin/gocover-cobertura > cobertura.xml
              # (Opcional) HTML de coverage para inspecci贸n
              go tool cover -html=coverage.out -o coverage.html
            displayName: "Run go test + coverage"

          - task: PublishTestResults@2
            displayName: "Publicar tests Backend (JUnit)"
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'backend/junit-backend.xml'
              testRunTitle: 'Go Unit Tests'
              failTaskOnFailedTests: true
            condition: succeededOrFailed()

          - task: PublishCodeCoverageResults@2
            displayName: 'Publicar coverage Backend'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/backend/cobertura.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/backend'
              failIfCoverageEmpty: false
            condition: succeededOrFailed()

          # (Opcional) publicar HTML de coverage del Back
          - task: PublishBuildArtifacts@1
            displayName: "Artefacto: coverage HTML Back"
            inputs:
              ArtifactName: 'coverage-back'
              PathtoPublish: 'backend/coverage.html'

  # =========================
  # 1) ANALISIS ESTATICO (SonarCloud)
  # =========================
  - stage: Static_Analysis_SonarCloud
    displayName: "Static Analysis (SonarCloud)"
    dependsOn: Frontend_Backend_Tests
    condition: succeeded()
    jobs:
      - job: SonarAnalysis
        displayName: "Run SonarCloud + Quality Gate"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self
            clean: true
            persistCredentials: true
            fetchDepth: 0   # <-- REQUERIDO por Sonar para blame

          - task: SonarCloudPrepare@2
            displayName: "SonarCloud Prepare"
            inputs:
              # Usa el TIPO "SonarQube Cloud" (as铆 aparece hoy en Azure)
              SonarCloud: 'SonarCloud'  # <-- NOMBRE EXACTO de tu Service Connection
              organization: 'simons15'               # <-- tu org
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: 'simons15_api_ecommerce' # <-- project key
              cliProjectName: 'api_ecommerce'         # <-- opcional

          - task: SonarCloudAnalyze@2
            displayName: "Run Sonar Analysis"

          - task: SonarCloudPublish@2
            displayName: "Publish Sonar Results (Quality Gate)"
            inputs:
              pollingTimeoutSec: '300'

  # =========================
  # 2) BUILD
  # =========================
  - stage: Build
    displayName: "Build Front + Back"
    dependsOn: Static_Analysis_SonarCloud
    condition: succeeded()
    jobs:
      - job: BuildJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          # --- Backend (Go) ---
          - task: GoTool@0
            inputs:
              version: '1.21.6'
          - script: |
              cd backend
              go mod download
              go build -o appweb-backend
            displayName: 'Build Go backend'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: 'backend'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
            displayName: 'Empaquetar backend'

          # --- Frontend (Vite) ---
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
          - script: |
              cd frontend
              npm ci
              VITE_API_URL=https://appweb-api-qa-cjc6b0hpbkbxgvf6.northcentralus-01.azurewebsites.net/api npm run build
            displayName: 'Build Front en Vite'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: 'frontend/dist'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
            displayName: 'Empaquetar frontend'

          - task: PublishBuildArtifacts@1
            inputs:
              ArtifactName: 'drop'
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            displayName: 'Publicar artefactos'

  # =========================
  # 3) QA
  # =========================
  - stage: Deploy_QA
    displayName: "Deploy QA"
    dependsOn: Build
    variables:
      - group: VG_QA
    jobs:
      - deployment: QADeploy
        displayName: 'Deploy a QA'
        environment: 'QA'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true
                  persistCredentials: true

                - download: current
                  artifact: drop

                # --- BACKEND QA ---
                - task: AzureWebApp@1
                  displayName: 'Deploy Backend QA'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'
                    appName: '$(webAppNameBack)'
                    package: '$(Pipeline.Workspace)/drop/backend.zip'

                - task: AzureAppServiceSettings@1
                  displayName: 'App Settings Backend QA'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'
                    appName: '$(webAppNameBack)'
                    appSettings: |
                      [
                        {"name":"DB_HOST","value":"$(DB_HOST)","slotSetting":false},
                        {"name":"DB_PORT","value":"$(DB_PORT)","slotSetting":false},
                        {"name":"DB_NAME","value":"$(DB_NAME)","slotSetting":false},
                        {"name":"DB_USER","value":"$(DB_USER)","slotSetting":false},
                        {"name":"DB_PASSWORD","value":"$(DB_PASSWORD)","slotSetting":false},
                        {"name":"DB_SSLMODE","value":"$(DB_SSLMODE)","slotSetting":false},
                        {"name":"PORT","value":"8080","slotSetting":false}
                      ]

                - script: |
                    BACK_URL="https://appweb-api-qa-cjc6b0hpbkbxgvf6.northcentralus-01.azurewebsites.net/api/healthz"
                    echo "Checking $BACK_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$BACK_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check backend FAILED"
                    exit 1
                  displayName: 'Health check Backend QA'

                # --- FRONTEND QA ---
                - task: NodeTool@0
                  inputs:
                    versionSpec: '20.x'
                - script: |
                    echo " Carpeta actual:"; pwd
                    echo " Contenido:"; ls -la
                    echo "Usando VITE_API_URL=$(VITE_API_URL)"
                    cd frontend
                    npm ci
                    VITE_API_URL=$(VITE_API_URL) npm run build
                  displayName: 'Build Vite con vars QA'

                - task: ArchiveFiles@2
                  inputs:
                    rootFolderOrFile: 'frontend/dist'
                    includeRootFolder: false
                    archiveType: 'zip'
                    archiveFile: '$(Pipeline.Workspace)/drop/frontend-qa.zip'
                  displayName: 'Empaquetar frontend QA'

                - task: AzureWebApp@1
                  displayName: 'Deploy Frontend QA'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'
                    appName: '$(webAppNameFront)'
                    package: '$(Pipeline.Workspace)/drop/frontend-qa.zip'

                - script: |
                    FRONT_URL="https://appweb-front-qa-ctg3cwawggeag6g4.northcentralus-01.azurewebsites.net/"
                    echo "Checking $FRONT_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$FRONT_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check frontend FAILED"
                    exit 1
                  displayName: 'Health check Frontend QA'


  # =========================
  # 4) PRODUCCIN (con aprobaci贸n)
  # =========================
  - stage: Deploy_Prod
    displayName: "Deploy Producci贸n"
    dependsOn: E2E_QA_Cypress
    variables:
      - group: VG_PROD
    jobs:
      - deployment: ProdDeploy
        displayName: 'Deploy a Producci贸n'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true
                  persistCredentials: true

                - download: current
                  artifact: drop

                - task: AzureWebApp@1
                  displayName: 'Deploy Backend PROD'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'
                    appName: '$(webAppNameBack)'
                    package: '$(Pipeline.Workspace)/drop/backend.zip'

                - task: AzureAppServiceSettings@1
                  displayName: 'App Settings Backend PROD'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'
                    appName: '$(webAppNameBack)'
                    appSettings: |
                      [
                        {"name":"DB_HOST","value":"$(DB_HOST)","slotSetting":false},
                        {"name":"DB_PORT","value":"$(DB_PORT)","slotSetting":false},
                        {"name":"DB_NAME","value":"$(DB_NAME)","slotSetting":false},
                        {"name":"DB_USER","value":"$(DB_USER)","slotSetting":false},
                        {"name":"DB_PASSWORD","value":"$(DB_PASSWORD)","slotSetting":false},
                        {"name":"DB_SSLMODE","value":"$(DB_SSLMODE)","slotSetting":false},
                        {"name":"PORT","value":"8080","slotSetting":false}
                      ]

                - script: |
                    BACK_URL="https://appweb-api-prod-hdhgb2bmb6eyaubv.chilecentral-01.azurewebsites.net/api/healthz"
                    echo "Checking $BACK_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$BACK_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check backend PROD FAILED"
                    exit 1
                  displayName: 'Health check Backend PROD'

                - task: NodeTool@0
                  inputs:
                    versionSpec: '20.x'
                - script: |
                    cd frontend
                    echo "Usando VITE_API_URL=$(VITE_API_URL)"
                    npm ci
                    VITE_API_URL=$(VITE_API_URL) npm run build
                  displayName: 'Build Vite con vars PROD'

                - task: ArchiveFiles@2
                  inputs:
                    rootFolderOrFile: 'frontend/dist'
                    includeRootFolder: false
                    archiveType: 'zip'
                    archiveFile: '$(Pipeline.Workspace)/drop/frontend-prod.zip'
                  displayName: 'Empaquetar frontend PROD'

                - task: AzureWebApp@1
                  displayName: 'Deploy Frontend PROD'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'
                    appName: '$(webAppNameFront)'
                    package: '$(Pipeline.Workspace)/drop/frontend-prod.zip'

                - script: |
                    FRONT_URL="https://appweb-front-prod-h7htdzbchbhsf6g2.northcentralus-01.azurewebsites.net/"
                    echo "Checking $FRONT_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$FRONT_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check frontend PROD FAILED"
                    exit 1
                  displayName: 'Health check Frontend PROD'
