trigger:
  - main

resources:
  repositories:
    - repository: self
      type: git
      name: APP_WEB
      ref: main
      checkoutOptions:
        clean: true
        submodules: false
      # Clonar en la subcarpeta APP_WEB para respetar tu estructura
      path: APP_WEB


# Variables globales m√≠nimas (pueden ir vac√≠as; usaremos Variable Groups)
variables:
  buildConfiguration: 'Release'

stages:
  # =========================
  # 1) BUILD
  # =========================
  - stage: Build
    displayName: "Build Front + Back"
    jobs:
      - job: BuildJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          # --- Backend (Go) ---
          - task: GoTool@0
            inputs:
              version: '1.21.6'        # Ajusta tu versi√≥n
          - script: |
              cd backend
              go mod download
              go build -o appweb-backend
            displayName: 'Build Go backend'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: 'backend'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/backend.zip'
              # El zip incluir√° el binario y (si tienes) carpeta 'public' o configs.
            displayName: 'Empaquetar backend'

          # --- Frontend (React) ---
          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'    # Ajusta si usas otra versi√≥n
          - script: |
              cd frontend
              npm ci
              # REACT_APP_API_URL se inyectar√° en QA/PROD, en Build no seteamos
              npm run build
            displayName: 'Build Front en Vite'

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: 'frontend/dist'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/frontend.zip'
            displayName: 'Empaquetar frontend'

          - task: PublishBuildArtifacts@1
            inputs:
              ArtifactName: 'drop'
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            displayName: 'Publicar artefactos'

  # =========================
  # 2) QA
  # =========================
  - stage: Deploy_QA
    displayName: "Deploy QA"
    dependsOn: Build
    variables:
      - group: VG_QA     # <- Variable Group QA
    jobs:
      - deployment: QADeploy
        displayName: 'Deploy a QA'
        environment: 'QA'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true
                  persistCredentials: true

                - download: current
                  artifact: drop

                # --- BACKEND QA ---
                - task: AzureWebApp@1
                  displayName: 'Deploy Backend QA'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'

                    appName: '$(webAppNameBack)'
                    package: '$(Pipeline.Workspace)/drop/backend.zip'


                # Setear App Settings (DB, etc.) por si cambian
                - task: AzureAppServiceSettings@1
                  displayName: 'App Settings Backend QA'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'

                    appName: '$(webAppNameBack)'
                    appSettings: |
                      [
                        {"name":"DB_HOST","value":"$(DB_HOST)","slotSetting":false},
                        {"name":"DB_PORT","value":"$(DB_PORT)","slotSetting":false},
                        {"name":"DB_NAME","value":"$(DB_NAME)","slotSetting":false},
                        {"name":"DB_USER","value":"$(DB_USER)","slotSetting":false},
                        {"name":"DB_PASSWORD","value":"$(DB_PASSWORD)","slotSetting":false},
                        {"name":"DB_SSLMODE","value":"$(DB_SSLMODE)","slotSetting":false},
                        {"name":"PORT","value":"8080","slotSetting":false}
                      ]

                # Health check backend
                - script: |
                    BACK_URL="https://appweb-api-qa-cjc6b0hpbkbxgvf6.northcentralus-01.azurewebsites.net/api/healthz"
                    echo "Checking $BACK_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$BACK_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check backend FAILED"
                    exit 1
                  displayName: 'Health check Backend QA'

                # --- FRONTEND QA ---
                # Volvemos a construir el front con la variable REACT_APP_API_URL de QA
                - task: NodeTool@0
                  inputs:
                    versionSpec: '18.x'
                - script: |
                    echo "üìÇ Carpeta actual:"
                    pwd
                    echo "üìÑ Contenido:"
                    ls -la
                    echo "Usando REACT_APP_API_URL=$(REACT_APP_API_URL)"

                    cd frontend
                    npm ci
                    npm run build
                  displayName: 'Build React con vars QA'

                - script: |
                    echo '{"apiUrl": "https://appweb-api-qa-cjc6b0hpbkbxgvf6.northcentralus-01.azurewebsites.net"}' > frontend/dist/config.json
                    echo "‚úÖ Archivo config.json QA generado"
                  displayName: 'crear config.json QA'

                - task: ArchiveFiles@2
                  inputs:
                    rootFolderOrFile: 'frontend/dist'
                    includeRootFolder: false
                    archiveType: 'zip'
                    archiveFile: '$(Pipeline.Workspace)/drop/frontend-qa.zip'
                  displayName: 'Empaquetar frontend QA'


                - task: AzureWebApp@1
                  displayName: 'Deploy Frontend QA'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'

                    appName: '$(webAppNameFront)'
                    package: '$(Pipeline.Workspace)/drop/frontend-qa.zip'



                # Health check frontend
                - script: |
                    FRONT_URL="https://appweb-front-qa-ctg3cwawggeag6g4.northcentralus-01.azurewebsites.net/"
                    echo "Checking $FRONT_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$FRONT_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check frontend FAILED"
                    exit 1
                  displayName: 'Health check Frontend QA'

  # =========================
  # 3) PRODUCCI√ìN (con aprobaci√≥n)
  # =========================
  - stage: Deploy_Prod
    displayName: "Deploy Producci√≥n"
    dependsOn: Deploy_QA
    variables:
      - group: VG_PROD   # <- Variable Group PROD
    jobs:
      - deployment: ProdDeploy
        displayName: 'Deploy a Producci√≥n'
        environment: 'Production'   # <- este env tiene aprobaci√≥n manual
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  clean: true
                  persistCredentials: true

                - download: current
                  artifact: drop

                # BACKEND PROD
                - task: AzureWebApp@1
                  displayName: 'Deploy Backend PROD'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'

                    appName: '$(webAppNameBack)'
                    package: '$(Pipeline.Workspace)/drop/backend.zip'

                - task: AzureAppServiceSettings@1
                  displayName: 'App Settings Backend PROD'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'

                    appName: '$(webAppNameBack)'
                    appSettings: |
                      [
                        {"name":"DB_HOST","value":"$(DB_HOST)","slotSetting":false},
                        {"name":"DB_PORT","value":"$(DB_PORT)","slotSetting":false},
                        {"name":"DB_NAME","value":"$(DB_NAME)","slotSetting":false},
                        {"name":"DB_USER","value":"$(DB_USER)","slotSetting":false},
                        {"name":"DB_PASSWORD","value":"$(DB_PASSWORD)","slotSetting":false},
                        {"name":"DB_SSLMODE","value":"$(DB_SSLMODE)","slotSetting":false},
                        {"name":"PORT","value":"8080","slotSetting":false}
                      ]

                - script: |
                    BACK_URL="https://appweb-api-prod-hdhgb2bmb6eyaubv.chilecentral-01.azurewebsites.net/api/healthz"
                    echo "Checking $BACK_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$BACK_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check backend PROD FAILED"
                    exit 1
                  displayName: 'Health check Backend PROD'


                # FRONTEND PROD (rebuild con URL de PROD)
                - task: NodeTool@0
                  inputs:
                    versionSpec: '18.x'
                - script: |
                    cd frontend
                    echo "Usando REACT_APP_API_URL=$(REACT_APP_API_URL)"
                    npm ci
                    npm run build
                  displayName: 'Build React con vars PROD'

                - script: |
                    echo '{"apiUrl": "https://appweb-api-prod-hdhgb2bmb6eyaubv.chilecentral-01.azurewebsites.net/api"}' > frontend/dist/config.json
                    echo "‚úÖ Archivo config.json PROD generado"
                  displayName: 'crear config.json PROD'

                - task: ArchiveFiles@2
                  inputs:
                    rootFolderOrFile: 'frontend/dist'
                    includeRootFolder: false
                    archiveType: 'zip'
                    archiveFile: '$(Pipeline.Workspace)/drop/frontend-prod.zip'
                  displayName: 'Empaquetar frontend PROD'

                - task: AzureWebApp@1
                  displayName: 'Deploy Frontend PROD'
                  inputs:
                    azureSubscription: 'sc-azure-appweb'

                    appName: '$(webAppNameFront)'
                    package: '$(Pipeline.Workspace)/drop/frontend-prod.zip'

                - script: |
                    FRONT_URL="https://appweb-front-prod-h7htdzbchbhsf6g2.northcentralus-01.azurewebsites.net/"
                    echo "Checking $FRONT_URL"
                    for i in {1..10}; do
                      code=$(curl -s -o /dev/null -w "%{http_code}" "$FRONT_URL")
                      echo "Intento $i => $code"
                      if [ "$code" = "200" ]; then
                        exit 0
                      fi
                      sleep 5
                    done
                    echo "Health check frontend PROD FAILED"
                    exit 1
                  displayName: 'Health check Frontend PROD'
